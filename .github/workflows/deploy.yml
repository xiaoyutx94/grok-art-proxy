name: Deploy to Cloudflare Workers

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  WORKER_NAME: grok-art-proxy

jobs:
  deploy:
    runs-on: ubuntu-latest
    name: Deploy
    steps:
      - name: Checkout
        uses: actions/checkout@v4

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'npm'

      - name: Install dependencies
        run: npm ci

      - name: Create D1 Database (if not exists)
        id: create-d1
        run: |
          # Try to create D1 database, ignore if already exists
          OUTPUT=$(npx wrangler d1 create ${{ env.WORKER_NAME }} 2>&1) || true
          echo "$OUTPUT"

          # Extract database_id from output
          if echo "$OUTPUT" | grep -q "database_id"; then
            D1_ID=$(echo "$OUTPUT" | grep "database_id" | sed 's/.*= "\(.*\)"/\1/')
            echo "d1_id=$D1_ID" >> $GITHUB_OUTPUT
            echo "Created new D1 database: $D1_ID"
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Create KV Namespace (if not exists)
        id: create-kv
        run: |
          # Try to create KV namespace, ignore if already exists
          OUTPUT=$(npx wrangler kv namespace create KV_CACHE 2>&1) || true
          echo "$OUTPUT"

          # Extract id from output (both create-success and already-exists messages)
          KV_ID=$(printf '%s\n' "$OUTPUT" | sed -n 's/.*id = "\([^"]*\)".*/\1/p' | head -n 1)
          if [ -z "$KV_ID" ]; then
            KV_ID=$(printf '%s\n' "$OUTPUT" | sed -n 's/.*"id"[[:space:]]*:[[:space:]]*"\([A-Fa-f0-9]\{32\}\)".*/\1/p' | head -n 1)
          fi

          if [ -n "$KV_ID" ]; then
            echo "kv_id=$KV_ID" >> $GITHUB_OUTPUT
            echo "Resolved KV namespace: $KV_ID"
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Get existing resource IDs
        id: get-resources
        run: |
          WORKER_NAME_FROM_TOML=$(grep -E '^[[:space:]]*name[[:space:]]*=' wrangler.toml | head -n 1 | sed -E 's/^[[:space:]]*name[[:space:]]*=[[:space:]]*"([^"]+)".*/\1/' || echo "")
          if [ -z "$WORKER_NAME_FROM_TOML" ]; then
            WORKER_NAME_FROM_TOML="${{ env.WORKER_NAME }}"
          fi

          D1_RAW=$(npx wrangler d1 list --json 2>/dev/null || echo "")
          D1_JSON=$(printf '%s\n' "$D1_RAW" | sed -n '/^[[:space:]]*\[/,/\][[:space:]]*$/p')
          D1_LIST_OK=false
          if echo "$D1_JSON" | jq empty >/dev/null 2>&1; then
            D1_LIST_OK=true
          fi

          KV_RAW=$(npx wrangler kv namespace list --json 2>/dev/null || echo "")
          KV_JSON=$(printf '%s\n' "$KV_RAW" | sed -n '/^[[:space:]]*\[/,/\][[:space:]]*$/p')
          KV_LIST_OK=false
          if echo "$KV_JSON" | jq empty >/dev/null 2>&1; then
            KV_LIST_OK=true
          fi

          # Get D1 database ID
          D1_ID="${{ secrets.D1_DATABASE_ID }}"
          if [ -z "$D1_ID" ] && [ -n "${{ steps.create-d1.outputs.d1_id }}" ]; then
            D1_ID="${{ steps.create-d1.outputs.d1_id }}"
          fi

          # Validate D1 ID from secret/create output against account list when available
          if [ -n "$D1_ID" ] && [ "$D1_LIST_OK" = "true" ]; then
            if ! echo "$D1_JSON" | jq -e --arg id "$D1_ID" '.[] | select(.uuid==$id)' >/dev/null 2>&1; then
              echo "::warning::D1 ID '$D1_ID' not found in current account list, will still use provided value."
            fi
          fi

          # If still empty, try to find existing database
          if [ -z "$D1_ID" ] && [ "$D1_LIST_OK" = "true" ]; then
            D1_ID=$(echo "$D1_JSON" | jq -r --arg worker "${{ env.WORKER_NAME }}" --arg worker_toml "$WORKER_NAME_FROM_TOML" '.[] | select(.name==$worker or .name==$worker_toml) | .uuid' | head -n 1)
          fi

          # Get KV namespace ID
          KV_ID="${{ secrets.KV_NAMESPACE_ID }}"
          if [ -z "$KV_ID" ] && [ -n "${{ steps.create-kv.outputs.kv_id }}" ]; then
            KV_ID="${{ steps.create-kv.outputs.kv_id }}"
          fi

          # Validate KV ID from secret/create output against account list when available
          if [ -n "$KV_ID" ] && [ "$KV_LIST_OK" = "true" ]; then
            if ! echo "$KV_JSON" | jq -e --arg id "$KV_ID" '.[] | select(.id==$id)' >/dev/null 2>&1; then
              echo "::warning::KV ID '$KV_ID' not found in current account list, will still use provided value."
            fi
          fi

          # If still empty, try to find existing namespace
          if [ -z "$KV_ID" ] && [ "$KV_LIST_OK" = "true" ]; then
            KV_ID=$(echo "$KV_JSON" | jq -r --arg worker "${{ env.WORKER_NAME }}" --arg worker_toml "$WORKER_NAME_FROM_TOML" '.[] | select(.title=="KV_CACHE" or .title==($worker + "-KV_CACHE") or .title==($worker + "-KV_CACHE_preview") or .title==($worker_toml + "-KV_CACHE") or .title==($worker_toml + "-KV_CACHE_preview")) | .id' | head -n 1)

            if [ -z "$KV_ID" ]; then
              KV_ID=$(echo "$KV_JSON" | jq -r '.[] | select(.title | test("KV_CACHE")) | .id' | head -n 1)
            fi
          fi

          # If still empty, try creating namespace directly (covers parse/list failures)
          if [ -z "$KV_ID" ]; then
            for KV_TITLE in "KV_CACHE" "${WORKER_NAME_FROM_TOML}-KV_CACHE"; do
              CREATE_KV_OUTPUT=$(npx wrangler kv namespace create "$KV_TITLE" 2>&1 || true)
              TRY_KV_ID=$(printf '%s\n' "$CREATE_KV_OUTPUT" | sed -n 's/.*id = "\([^"]*\)".*/\1/p' | head -n 1)
              if [ -z "$TRY_KV_ID" ]; then
                TRY_KV_ID=$(printf '%s\n' "$CREATE_KV_OUTPUT" | sed -n 's/.*"id"[[:space:]]*:[[:space:]]*"\([A-Fa-f0-9]\{32\}\)".*/\1/p' | head -n 1)
              fi

              if [ -n "$TRY_KV_ID" ]; then
                KV_ID="$TRY_KV_ID"
                echo "Resolved KV namespace via create '$KV_TITLE': $KV_ID"
                break
              fi
            done
          fi

          # Validate KV ID again after create fallback
          if [ -n "$KV_ID" ] && [ "$KV_LIST_OK" = "true" ]; then
            if ! echo "$KV_JSON" | jq -e --arg id "$KV_ID" '.[] | select(.id==$id)' >/dev/null 2>&1; then
              echo "::warning::Resolved KV ID '$KV_ID' not present in listed namespaces."
            fi
          fi

          if [ -z "$D1_ID" ]; then
            echo "::warning::Unable to resolve D1 ID from Cloudflare API. Ensure token has D1 permissions or set D1_DATABASE_ID secret."
          fi

          if [ -z "$KV_ID" ]; then
            echo "::warning::Unable to resolve KV ID from Cloudflare API. Ensure token has KV permissions or set KV_NAMESPACE_ID secret."
          fi

          echo "d1_id=$D1_ID" >> $GITHUB_OUTPUT
          echo "kv_id=$KV_ID" >> $GITHUB_OUTPUT
          echo "D1 Database ID: $D1_ID"
          echo "KV Namespace ID: $KV_ID"
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Update wrangler.toml
        run: |
          D1_ID="${{ steps.get-resources.outputs.d1_id }}"
          KV_ID="${{ steps.get-resources.outputs.kv_id }}"

          if [ -z "$D1_ID" ]; then
            D1_ID="${{ secrets.D1_DATABASE_ID }}"
          fi
          if [ -z "$D1_ID" ]; then
            D1_ID="${{ steps.create-d1.outputs.d1_id }}"
          fi

          if [ -z "$KV_ID" ]; then
            KV_ID="${{ secrets.KV_NAMESPACE_ID }}"
          fi
          if [ -z "$KV_ID" ]; then
            KV_ID="${{ steps.create-kv.outputs.kv_id }}"
          fi

          D1_ID=$(echo "$D1_ID" | tr -d '[:space:]')
          KV_ID=$(echo "$KV_ID" | tr -d '[:space:]')

          if [ -n "$D1_ID" ]; then
            sed -i "s/database_id = \"YOUR_D1_DATABASE_ID\"/database_id = \"$D1_ID\"/" wrangler.toml
            sed -i -E "s/^[[:space:]]*database_id = \".*\"/database_id = \"$D1_ID\"/" wrangler.toml
          else
            echo "::error::D1 Database ID not found. Please set D1_DATABASE_ID secret."
            exit 1
          fi

          if [ -n "$KV_ID" ]; then
            sed -i "s/id = \"YOUR_KV_NAMESPACE_ID\"/id = \"$KV_ID\"/" wrangler.toml
            sed -i -E "s/^[[:space:]]*id = \".*\"/id = \"$KV_ID\"/" wrangler.toml
          else
            echo "::error::KV Namespace ID not found. Please set KV_NAMESPACE_ID secret in this repository and ensure workflow has permission to read it."
            exit 1
          fi

          echo "Updated wrangler.toml:"
          cat wrangler.toml

      - name: Run D1 Migrations
        run: npx wrangler d1 migrations apply DB --remote
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deploy to Cloudflare Workers
        run: npx wrangler deploy
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Set Authentication Secrets
        run: |
          if [ -n "${{ secrets.AUTH_USERNAME }}" ]; then
            echo "${{ secrets.AUTH_USERNAME }}" | npx wrangler secret put AUTH_USERNAME 2>/dev/null || \
            echo "${{ secrets.AUTH_USERNAME }}" | npx wrangler secret put AUTH_USERNAME --force 2>/dev/null || true
          fi

          if [ -n "${{ secrets.AUTH_PASSWORD }}" ]; then
            echo "${{ secrets.AUTH_PASSWORD }}" | npx wrangler secret put AUTH_PASSWORD 2>/dev/null || \
            echo "${{ secrets.AUTH_PASSWORD }}" | npx wrangler secret put AUTH_PASSWORD --force 2>/dev/null || true
          fi
        env:
          CLOUDFLARE_API_TOKEN: ${{ secrets.CLOUDFLARE_API_TOKEN }}
          CLOUDFLARE_ACCOUNT_ID: ${{ secrets.CLOUDFLARE_ACCOUNT_ID }}

      - name: Deployment Summary
        run: |
          echo "## Deployment Complete!" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Access URL" >> $GITHUB_STEP_SUMMARY
          echo "https://${{ env.WORKER_NAME }}.<your-account>.workers.dev" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Resources" >> $GITHUB_STEP_SUMMARY
          echo "- D1 Database: \`${{ steps.get-resources.outputs.d1_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "- KV Namespace: \`${{ steps.get-resources.outputs.kv_id }}\`" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Next Steps" >> $GITHUB_STEP_SUMMARY
          echo "1. Login with your configured credentials" >> $GITHUB_STEP_SUMMARY
          echo "2. Add your Grok tokens to start generating images" >> $GITHUB_STEP_SUMMARY
